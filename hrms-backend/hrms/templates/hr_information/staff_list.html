{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KATH HRM - Staff Records</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

	<style>
		:root {
			--kath-red: #C8102E;
			--kath-dark-red: #A00D24;
		}

		body {
			background: linear-gradient(135deg, #f8f9fa, #e9ecef);
			min-height: 100vh;
		}

		.bg-kath-red { background-color: var(--kath-red) !important; }
		.text-kath-red { color: var(--kath-red) !important; }

		.records-card {
			border: none;
			box-shadow: 0 10px 25px rgba(0,0,0,0.08);
		}

		.filter-card {
			border: none;
			box-shadow: 0 5px 15px rgba(0,0,0,0.05);
			background-color: #fff;
		}

		.search-section {
			margin-bottom: 2rem;
		}

		.table-responsive {
			border-radius: 0.5rem;
			overflow: hidden;
		}

		.table {
			margin-bottom: 0;
		}

		.table tbody tr {
			border-bottom: 1px solid #f0f0f0;
		}

		.table tbody tr:hover {
			background-color: #f9f9f9;
		}

		.staff-name {
			font-weight: 600;
			color: #212529;
		}

		.staff-number {
			font-size: 0.85rem;
			color: #6c757d;
		}

		.badge-status {
			padding: 0.4rem 0.75rem;
			font-weight: 500;
			font-size: 0.85rem;
		}

		.status-active {
			background-color: #d4edda;
			color: #155724;
		}

		.status-leave {
			background-color: #fff3cd;
			color: #856404;
		}

		.status-retired {
			background-color: #e2e3e5;
			color: #383d41;
		}

		.action-btn {
			padding: 0.4rem 0.8rem;
			font-size: 0.85rem;
			display: inline-flex;
			align-items: center;
			gap: 0.25rem;
			white-space: nowrap;
		}

		.action-cell {
			display: flex;
			gap: 0.5rem;
			justify-content: center;
			flex-wrap: nowrap;
		}

		.pagination {
			justify-content: center;
		}

		.filter-label {
			font-weight: 600;
			color: #495057;
			font-size: 0.95rem;
		}

		/* Statistics Cards */
		.quick-stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 1.25rem;
			margin-bottom: 2rem;
		}

		.stat-card {
			border: none;
			box-shadow: 0 5px 15px rgba(0,0,0,0.08);
			transition: transform 0.2s, box-shadow 0.2s;
		}

		.stat-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.12);
		}

		.stat-label {
			font-size: 0.95rem;
			font-weight: 600;
			color: #495057;
		}

		.stat-number {
			font-size: 2rem;
			font-weight: 700;
			color: var(--kath-red);
		}

		.btn-kath-red {
			background-color: #C8102E;
			border-color: #C8102E;
			color: white;
		}
		.btn-kath-red:hover {
			background-color: #A00D24;
			border-color: #A00D24;
			color: white;
		}

		.no-results {
			text-align: center;
			padding: 3rem 1rem;
			color: #6c757d;
		}
	</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-kath-red shadow-sm sticky-top">
	<div class="container-fluid px-4">
		<a class="navbar-brand d-flex align-items-center gap-2 text-white" href="{% url 'dashboard' %}">
			<img src="{% static 'img/kath-logo.png' %}" alt="KATH Logo" style="height:32px; filter:brightness(0) invert(1);">
			<span class="fw-bold">KATH HRM</span>
		</a>

		<button class="navbar-toggler border-0" data-bs-toggle="collapse" data-bs-target="#navbarNav">
			<i class="fas fa-bars text-white"></i>
		</button>

		<div class="collapse navbar-collapse" id="navbarNav">
			<ul class="navbar-nav ms-auto align-items-lg-center gap-2">
				<li class="nav-item">
					<a class="nav-link text-white active">
						<i class="fas fa-users me-1"></i> Staff Records
					</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle text-white" data-bs-toggle="dropdown">
						<span class="badge bg-white text-kath-red">Admin</span>
					</a>
					<ul class="dropdown-menu dropdown-menu-end">
						<li><a class="dropdown-item">Profile</a></li>
						<li><a class="dropdown-item">Settings</a></li>
						<li><hr class="dropdown-divider"></li>
						<li><a class="dropdown-item text-danger">Logout</a></li>
					</ul>
				</li>
			</ul>
		</div>
	</div>
</nav>

<!-- MAIN CONTENT -->
<div class="container-fluid p-4">
	<div class="container">

		<!-- PAGE HEADER -->
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<h2 class="mb-1">Staff Records</h2>
				<p class="text-muted mb-0">Browse and search all personnel</p>
			</div>
			<div class="d-flex gap-2">
				<a class="btn btn-kath-red" href="{% url 'create_staff' %}"><i class="fas fa-plus me-2"></i>New Staff</a>
				<a class="btn btn-outline-secondary" href="{% url 'dashboard' %}"><i class="fas fa-arrow-left me-2"></i>Back</a>
			</div>
		</div>

		<!-- QUICK STATISTICS -->
		<div class="quick-stats-grid">
			<!-- Full-Time Employees Card -->
			<div class="card stat-card">
				<div class="card-body">
					<p class="stat-label mb-2"><i class="fas fa-file-contract me-2 text-kath-red"></i>Full-Time Employees</p>
					<p class="stat-number mb-0">{{ full_time }}</p>
					<small class="text-muted d-block mt-1">Active staff</small>
				</div>
			</div>

			<!-- New Hires Card -->
			<div class="card stat-card">
				<div class="card-body">
					<p class="stat-label mb-2"><i class="fas fa-user-plus me-2" style="color: #28a745;"></i>On Leave</p>
					<p class="stat-number mb-0" style="color: #28a745;">{{ new_hires }}</p>
					<small class="text-muted d-block mt-1">Currently on leave</small>
				</div>
			</div>

			<!-- Departments Card -->
			<div class="card stat-card">
				<div class="card-body">
					<p class="stat-label mb-2"><i class="fas fa-building me-2" style="color: #0d6efd;"></i>Directorates</p>
					<p class="stat-number mb-0" style="color: #0d6efd;">{{ departments }}</p>
					<small class="text-muted d-block mt-1">Across organization</small>
				</div>
			</div>

			<!-- Job Positions Card -->
			<div class="card stat-card">
				<div class="card-body">
					<p class="stat-label mb-2"><i class="fas fa-briefcase me-2" style="color: #6f42c1;"></i>Job Positions</p>
					<p class="stat-number mb-0" style="color: #6f42c1;">{{ job_positions }}</p>
					<small class="text-muted d-block mt-1">Unique roles</small>
				</div>
			</div>
		</div>

		<!-- FILTERS SECTION -->
		<div class="card filter-card mb-4">
			<div class="card-body">
				<div class="row g-3">
					<!-- Department Filter -->
					<div class="col-md-3">
						<label class="filter-label mb-2"><i class="fas fa-building me-2"></i>Directorate</label>
						<select class="form-select" id="departmentFilter">
							<option value="">All Directorates</option>
							{% for directorate in directorates %}
								<option value="{{ directorate }}">{{ directorate }}</option>
							{% endfor %}
						</select>
					</div>

					<!-- Category Filter -->
					<div class="col-md-3">
						<label class="filter-label mb-2"><i class="fas fa-tag me-2"></i>Category</label>
						<select class="form-select" id="categoryFilter">
							<option value="">All Categories</option>
							<option value="Clinical">Clinical</option>
							<option value="Administrative">Administrative</option>
							<option value="Support">Support</option>
						</select>
					</div>

					<!-- Status Filter -->
					<div class="col-md-3">
						<label class="filter-label mb-2"><i class="fas fa-circle-notch me-2"></i>Status</label>
						<select class="form-select" id="statusFilter">
							<option value="">All Status</option>
							{% for status in work_statuses %}
								<option value="{{ status }}">{{ status }}</option>
							{% endfor %}
						</select>
					</div>
					<!--- add a filter with month but filter based on month of birth -->
					<div class="col-md-3">
						<label class="filter-label mb-2"><i class="fas fa-birthday-cake me-2"></i>Birth Month</label>
						<select class="form-select" id="birthMonthFilter">
							<option value="">All Months</option>
							<option value="January">January</option>
							<option value="February">February</option>
							<option value="March">March</option>
							<option value="April">April</option>
							<option value="May">May</option>
							<option value="June">June</option>
							<option value="July">July</option>
							<option value="August">August</option>
							<option value="September">September</option>
							<option value="October">October</option>
							<option value="November">November</option>
							<option value="December">December</option>
						</select>
					</div>

					<!-- Clear Filters Button -->
					<div class="col-md-3 d-flex align-items-end">
						<button class="btn btn-outline-secondary w-100" id="clearBtn"><i class="fas fa-times me-2"></i>Clear Filters</button>
					</div>
				</div>
			</div>
		</div>

		<!-- RECORDS TABLE -->
		<div class="card records-card">
			<!-- Search Section Inside Table Card -->
			<div class="card-header bg-white border-bottom">
				<div class="row g-3 align-items-end">
					<div class="col-md-9">
						<label class="filter-label mb-2"><i class="fas fa-search me-2"></i>Search Staff</label>
						<input type="text" id="searchInput" class="form-control" placeholder="Search by name, staff number, or ID...">
					</div>
					<div class="col-md-3">
						<button class="btn btn-kath-red w-100" id="searchBtn"><i class="fas fa-search me-2"></i>Search</button>
					</div>
				</div>
			</div>
			<div class="table-responsive">
				<table class="table table-hover" id="staffTable">
					<thead class="table-light">
						<tr>
							<th style="width: 12%;">Staff No.</th>
							<th style="width: 18%;">Full Name</th>
							<th style="width: 12%;">Category</th>
							<th style="width: 15%;">Job Title</th>
							<th style="width: 15%;">Directorate</th>
							<th style="width: 10%;">contact</th>
							<th style="width: 10%;">Status</th>
							<th style="width: 8%; text-align: center;">Action</th>
						</tr>
					</thead>
					<tbody id="staffTableBody">
						{% for employee in staff %}
						<tr data-birth-month="{{ employee.birth_month }}">
							<td>
								<strong>{{ employee.kath_staff_number }}</strong>
								<div class="staff-number">{{ employee.employee_id }}</div>
							</td>
							<td>
								<strong class="staff-name">{{ employee.first_name }} {{ employee.surname }}{% if employee.other_names %} {{ employee.other_names }}{% endif %}</strong>
							</td>
							<td>
								<span class="badge bg-primary bg-opacity-10 text-primary">{{ employee.category_of_profession }}</span>
							</td>
							<td>{{ employee.profession }}</td>
							<td>{{ employee.directorate }}</td>
							<td>{{ employee.contact_number }}</td>
							<td>
								{% if employee.work_status == 'Active' %}
									<span class="badge badge-status status-active"><i class="fas fa-check-circle me-1"></i>{{ employee.work_status }}</span>
								{% elif employee.work_status == 'On Leave' %}
									<span class="badge badge-status status-leave"><i class="fas fa-calendar-alt me-1"></i>{{ employee.work_status }}</span>
								{% else %}
									<span class="badge badge-status status-retired"><i class="fas fa-door-open me-1"></i>{{ employee.work_status }}</span>
								{% endif %}
							</td>
							<td style="text-align: center;">
								<div class="action-cell">
									<a href="{% url 'staff_profile' staff_id=employee.id %}" class="btn btn-sm btn-outline-primary action-btn" title="View Profile">
										<i class="fas fa-eye me-1"></i>
									</a>
									<a href="{% url 'print_record' staff_id=employee.id %}" class="btn btn-sm btn-outline-secondary action-btn" target="_blank" title="Print Record">
										<i class="fas fa-print me-1"></i>
									</a>
									<a href="{% url 'edit_staff' staff_id=employee.id %}" class="btn btn-sm btn-outline-warning action-btn" title="Edit Record">
										<i class="fas fa-edit me-1"></i>
									</a>
								</div>
							</td>
						</tr>
						{% empty %}
						<tr>
							<td colspan="7" class="text-center text-muted py-4">No staff records found</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
				<div id="noResults" class="no-results" style="display: none;">
					<i class="fas fa-search fa-3x mb-3"></i>
					<h5>No Results Found</h5>
					<p>Try adjusting your search criteria or filters</p>
				</div>
			</div>

			<!-- Pagination -->
			<div class="card-footer bg-white border-top">
				<nav aria-label="Page navigation">
					<ul class="pagination mb-0">
						<li class="page-item disabled">
							<a class="page-link" href="#"><i class="fas fa-chevron-left me-1"></i>Previous</a>
						</li>
						<li class="page-item active"><a class="page-link" href="#">1</a></li>
						<li class="page-item"><a class="page-link" href="#">2</a></li>
						<li class="page-item"><a class="page-link" href="#">3</a></li>
						<li class="page-item">
							<a class="page-link" href="#">Next <i class="fas fa-chevron-right ms-1"></i></a>
						</li>
					</ul>
				</nav>
				<small class="text-muted d-block mt-2" id="resultsCount">Showing 1-5 of {{ total_staff }} staff records</small>
			</div>
		</div>

	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
	// Search and Filter Functionality
	document.addEventListener('DOMContentLoaded', function() {
		const searchInput = document.getElementById('searchInput');
		const departmentFilter = document.getElementById('departmentFilter');
		const categoryFilter = document.getElementById('categoryFilter');
		const statusFilter = document.getElementById('statusFilter');
		const birthMonthFilter = document.getElementById('birthMonthFilter');
		const searchBtn = document.getElementById('searchBtn');
		const clearBtn = document.getElementById('clearBtn');
		const tableBody = document.getElementById('staffTableBody');
		const noResults = document.getElementById('noResults');
		const resultsCount = document.getElementById('resultsCount');

		// Month name to number mapping
		const monthMap = {
			'january': 1, 'february': 2, 'march': 3, 'april': 4,
			'may': 5, 'june': 6, 'july': 7, 'august': 8,
			'september': 9, 'october': 10, 'november': 11, 'december': 12
		};

		function filterTable() {
			const searchTerm = searchInput.value.toLowerCase().trim();
			const department = departmentFilter.value.toLowerCase();
			const category = categoryFilter.value.toLowerCase();
			const status = statusFilter.value.toLowerCase();
			const birthMonth = birthMonthFilter.value.toLowerCase();
			const birthMonthNum = birthMonth ? monthMap[birthMonth] : null;

			const rows = tableBody.getElementsByTagName('tr');
			let visibleCount = 0;

			for (let row of rows) {
				const staffNo = row.cells[0].textContent.toLowerCase();
				const name = row.cells[1].textContent.toLowerCase();
				const rowCategory = row.cells[2].textContent.toLowerCase();
				const jobTitle = row.cells[3].textContent.toLowerCase();
				const rowDepartment = row.cells[4].textContent.toLowerCase();
				
				// Extract status from badge span - get the text after the icon
				const statusBadge = row.cells[5].querySelector('.badge');
				const rowStatus = statusBadge ? statusBadge.textContent.toLowerCase().trim() : row.cells[5].textContent.toLowerCase().trim();
				
				const rowBirthMonth = parseInt(row.getAttribute('data-birth-month'));

				const matchesSearch = searchTerm === '' || 
					staffNo.includes(searchTerm) || 
					name.includes(searchTerm) ||
					jobTitle.includes(searchTerm);

				const matchesDepartment = department === '' || rowDepartment.includes(department);
				const matchesCategory = category === '' || rowCategory.includes(category);
				const matchesStatus = status === '' || rowStatus.includes(status);
				const matchesBirthMonth = birthMonthNum === null || rowBirthMonth === birthMonthNum;

				if (matchesSearch && matchesDepartment && matchesCategory && matchesStatus && matchesBirthMonth) {
					row.style.display = '';
					visibleCount++;
				} else {
					row.style.display = 'none';
				}
			}

			// Show/hide no results message
			if (visibleCount === 0) {
				noResults.style.display = 'block';
				tableBody.parentElement.style.display = 'none';
			} else {
				noResults.style.display = 'none';
				tableBody.parentElement.style.display = 'table';
			}

			// Update results count
			resultsCount.textContent = `Showing ${visibleCount} of ${rows.length} staff records`;
		}

		// Event listeners
		searchBtn.addEventListener('click', filterTable);
		
		// Auto-search as user types
		searchInput.addEventListener('input', filterTable);
		
		searchInput.addEventListener('keyup', function(e) {
			if (e.key === 'Enter') {
				filterTable();
			}
		});

		departmentFilter.addEventListener('change', filterTable);
		categoryFilter.addEventListener('change', filterTable);
		statusFilter.addEventListener('change', filterTable);
		birthMonthFilter.addEventListener('change', filterTable);

		clearBtn.addEventListener('click', function() {
			searchInput.value = '';
			departmentFilter.value = '';
			categoryFilter.value = '';
			statusFilter.value = '';
			birthMonthFilter.value = '';
			filterTable();
		});
	});
</script>
</body>
</html>